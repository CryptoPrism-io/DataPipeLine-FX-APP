name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, 'claude/**' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run hourly data fetch (every hour)
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.10'

jobs:
  # Job 1: Lint and Test
  test:
    name: Test and Lint
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: fx_trading_data
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black

      - name: Run linter (flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Check code formatting (black)
        run: black --check .
        continue-on-error: true

      - name: Initialize database
        env:
          PGPASSWORD: postgres
          OANDA_API_KEY: ${{ secrets.OANDA_API_KEY }}
        run: |
          echo "Creating database schema..."
          export PGPASSWORD=postgres
          psql -h localhost -U postgres -d fx_trading_data -f database/schema.sql

      - name: Run tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: fx_trading_data
          DB_USER: postgres
          DB_PASSWORD: postgres
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          OANDA_API_KEY: ${{ secrets.OANDA_API_KEY }}
          OANDA_ENVIRONMENT: demo
        run: |
          # Run tests if they exist
          if [ -d "tests" ]; then
            pytest tests/ -v --cov=. --cov-report=xml --cov-report=term
          else
            echo "No tests directory found - skipping tests"
          fi
        continue-on-error: true

  # Job 2: Fetch and Store FX Data (runs on schedule or manual trigger)
  # Uses EXTERNAL PostgreSQL database for persistent storage
  fetch-data:
    name: Fetch FX Data to External DB
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test database connection
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "Testing connection to external database..."
          psql -h ${{ secrets.POSTGRES_HOST }} -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -c "SELECT version();"
          echo "✓ Database connection successful!"

      - name: Initialize database schema (if needed)
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "Ensuring database schema exists..."
          psql -h ${{ secrets.POSTGRES_HOST }} -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -f database/schema.sql
          echo "✓ Schema initialized"

      - name: Run hourly data fetch
        env:
          DB_HOST: ${{ secrets.POSTGRES_HOST }}
          DB_PORT: ${{ secrets.POSTGRES_PORT || '5432' }}
          DB_NAME: ${{ secrets.POSTGRES_DB }}
          DB_USER: ${{ secrets.POSTGRES_USER }}
          DB_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST || 'localhost' }}
          REDIS_PORT: ${{ secrets.REDIS_PORT || '6379' }}
          OANDA_API_KEY: ${{ secrets.OANDA_API_KEY }}
          OANDA_ENVIRONMENT: demo
          HOURLY_JOB_ENABLED: 'True'
          DAILY_JOB_ENABLED: 'False'
        run: |
          echo "Fetching latest FX data from OANDA API..."
          echo "Target database: ${{ secrets.POSTGRES_HOST }}"
          python jobs/hourly_job.py
          echo "✓ Data fetch completed!"

      - name: Verify data was stored
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "Verifying data in database..."
          psql -h ${{ secrets.POSTGRES_HOST }} -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -c "
            SELECT
              'Candles: ' || COUNT(*) FROM oanda_candles
              UNION ALL
              SELECT 'Volatility: ' || COUNT(*) FROM volatility_metrics
              UNION ALL
              SELECT 'Correlations: ' || COUNT(*) FROM correlation_matrix;
          "
          echo "✓ Data verification complete!"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-fetch-logs
          path: logs/
          retention-days: 7

  # Job 3: Build and validate
  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify imports
        run: |
          python -c "from utils.config import *; print('Config loaded successfully')"
          python -c "from utils.db_connection import DatabaseConnection; print('DB module loaded')"
          python -c "from cache.redis_client import RedisClient; print('Redis module loaded')"
          echo "All modules imported successfully!"
